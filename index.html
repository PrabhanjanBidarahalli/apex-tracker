<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#05080f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Prabhanjan ‚Äî Productivity Tracker</title>
<link rel="manifest" id="manifest-placeholder">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,900;1,400;1,700&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #070a12;
  --surface: rgba(255,255,255,0.03);
  --surface2: rgba(255,255,255,0.055);
  --glass: rgba(10,14,24,0.72);
  --border: rgba(255,255,255,0.06);
  --text: #e6ecf5;
  --text2: rgba(200,210,225,0.6);
  --text3: rgba(140,155,175,0.4);
  --teal: #00c9a7;
  --blue: #38bdf8;
  --violet: #a78bfa;
  --rose: #fb7185;
  --emerald: #34d399;
  --gold: #f5c842;
  --gold2: #e8a928;
  --nav-h: 68px;
  --ease: cubic-bezier(0.16, 1, 0.3, 1);
  --ease2: cubic-bezier(0.4, 0, 0.2, 1);
}

/* ‚îÄ‚îÄ LIGHT MODE ‚îÄ‚îÄ */
html.light {
  --bg: #f0f2f8;
  --surface: rgba(255,255,255,0.82);
  --surface2: rgba(255,255,255,0.95);
  --glass: rgba(240,242,248,0.88);
  --border: rgba(0,0,0,0.08);
  --text: #0f1523;
  --text2: rgba(30,40,60,0.65);
  --text3: rgba(60,75,100,0.4);
  --teal: #00a98a;
  --blue: #0ea5e9;
  --violet: #7c3aed;
  --rose: #e11d48;
  --emerald: #059669;
  --gold: #d97706;
  --gold2: #b45309;
}
html.light body { background: var(--bg); }
html.light #cosmos { opacity: 0.07; }
html.light header { background: rgba(240,242,248,0.92); box-shadow: 0 1px 12px rgba(0,0,0,.08); }
html.light .card { background: #fff; border-color: rgba(0,0,0,.07); box-shadow: 0 2px 16px rgba(0,0,0,.06); }
html.light .wins-card { background: linear-gradient(135deg,rgba(5,150,105,.07),rgba(0,169,138,.05)); }
html.light .modal { background: rgba(250,251,254,.98); }
html.light .modal-overlay { background: rgba(0,0,0,.45); }
html.light .input { background: rgba(0,0,0,.04); border-color: rgba(0,0,0,.1); color: var(--text); }
html.light .input:focus { border-color: var(--teal); background: #fff; }
html.light .btn-ghost { border-color: rgba(0,0,0,.12); color: var(--text2); }
html.light .btn-ghost:hover { background: rgba(0,0,0,.05); }
html.light .nav-bar { background: rgba(245,247,252,.95); border-color: rgba(0,0,0,.07); }
html.light .ts-card { background: #fff; border-color: rgba(0,0,0,.07); }
html.light .ts-empty { background: rgba(0,0,0,.02); border-color: rgba(0,0,0,.07); }
html.light .ts-stab { border-color: rgba(0,0,0,.1); color: var(--text3); }
html.light .wins-stat { background: rgba(0,0,0,.03); }
html.light .habit-item { background: rgba(0,0,0,.02); border-color: rgba(0,0,0,.06); }
html.light .section-title { color: var(--text); }
html.light .hero-card { background: linear-gradient(135deg,rgba(0,169,138,.1),rgba(14,165,233,.08)); border-color: rgba(0,169,138,.2); }
html.light .week-day { background: rgba(0,0,0,.03); }
html.light .week-day.today { background: rgba(0,169,138,.1); }
html.light .dc { background: rgba(0,0,0,.03); }
html.light .streak-chip { background: rgba(217,119,6,.12); border-color: rgba(217,119,6,.25); color: var(--gold); }
html.light .goal-item { background: #fff; border-color: rgba(0,0,0,.07); }
html.light .tag { border-color: rgba(0,0,0,.1); color: var(--text3); }
html.light .tag.active { background: rgba(0,169,138,.1); color: var(--teal); border-color: rgba(0,169,138,.3); }
html.light .pw .pb { background: rgba(0,0,0,.07); }
html.light .logo { background: linear-gradient(135deg,#00a98a,#0ea5e9); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
html.light .grain { opacity: 0; }

/* Theme toggle button */
.theme-toggle {
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  font-size: 16px;
  background: var(--surface2);
  border: 1.5px solid var(--border);
  transition: all .25s;
  flex-shrink: 0;
}
.theme-toggle:hover { transform: rotate(20deg) scale(1.1); border-color: var(--teal); }

*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;line-height:1.6;overflow:hidden;-webkit-font-smoothing:antialiased}

/* ‚îÄ‚îÄ COSMOS ‚îÄ‚îÄ */
#cosmos{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
#starCanvas{position:absolute;inset:0;opacity:.5}
.orb{position:absolute;border-radius:50%;filter:blur(80px);animation:orbFloat 20s ease-in-out infinite}
.orb.o1{width:600px;height:400px;background:radial-gradient(ellipse,rgba(0,201,167,.16) 0%,transparent 70%);top:-100px;left:-80px;animation-delay:0s}
.orb.o2{width:500px;height:500px;background:radial-gradient(ellipse,rgba(139,92,246,.13) 0%,transparent 70%);top:20%;right:-150px;animation-delay:-7s}
.orb.o3{width:700px;height:350px;background:radial-gradient(ellipse,rgba(14,165,233,.11) 0%,transparent 70%);bottom:0;left:15%;animation-delay:-13s}
.orb.o4{width:300px;height:300px;background:radial-gradient(ellipse,rgba(245,200,66,.07) 0%,transparent 70%);top:50%;left:50%;animation-delay:-5s}
@keyframes orbFloat{0%{opacity:0;transform:translate(0,0) scale(1)}15%{opacity:1}50%{transform:translate(40px,-30px) scale(1.08)}85%{opacity:1}100%{opacity:0;transform:translate(0,0) scale(1)}}
.grain{position:fixed;inset:0;z-index:1;pointer-events:none;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");opacity:.025}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app{display:flex;flex-direction:column;height:100vh;height:100dvh;position:relative;z-index:2}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:58px;background:rgba(7,10,18,.85);backdrop-filter:blur(24px) saturate(1.5);-webkit-backdrop-filter:blur(24px);border-bottom:1px solid var(--border);flex-shrink:0;position:relative}
header::after{content:'';position:absolute;bottom:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,var(--teal),var(--blue),var(--violet),transparent);opacity:.3}
.logo{font-family:'Playfair Display',serif;font-weight:900;font-size:22px;letter-spacing:2px;background:linear-gradient(135deg,var(--gold) 0%,var(--teal) 50%,var(--blue) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative}
.logo::before{content:'Prabhanjan';position:absolute;inset:0;background:linear-gradient(135deg,var(--gold),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:blur(8px);opacity:.4}
.header-right{display:flex;align-items:center;gap:10px}
.streak-chip{display:flex;align-items:center;gap:5px;padding:5px 12px;background:rgba(245,200,66,.08);border:1px solid rgba(245,200,66,.22);border-radius:20px;font-family:'DM Mono',monospace;font-size:12px;color:var(--gold);letter-spacing:.5px}
.sync-btn{display:flex;align-items:center;gap:6px;padding:5px 13px;background:var(--surface);border:1px solid var(--border);border-radius:20px;color:var(--text2);font-size:11px;font-family:'DM Mono',monospace;cursor:pointer;transition:all .25s;letter-spacing:.5px}
.sync-btn:hover{border-color:var(--teal);color:var(--teal);box-shadow:0 0 14px rgba(0,201,167,.15)}
.sync-btn.synced{border-color:var(--emerald);color:var(--emerald)}
.sync-btn.syncing{border-color:var(--gold);color:var(--gold);animation:pulse 1.2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ‚îÄ‚îÄ MAIN / VIEWS ‚îÄ‚îÄ */
main{flex:1;overflow:hidden;position:relative}
.view{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;padding:22px 18px 90px;display:none;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.06) transparent}
.view::-webkit-scrollbar{width:3px}
.view::-webkit-scrollbar-thumb{background:rgba(255,255,255,.07);border-radius:2px}
.view.active{display:block;animation:viewIn .4s var(--ease) both}
@keyframes viewIn{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ GLASS CARDS ‚îÄ‚îÄ */
.card{background:var(--glass);backdrop-filter:blur(20px) saturate(1.3);-webkit-backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:18px;padding:20px;margin-bottom:14px;position:relative;overflow:hidden;transition:border-color .3s,box-shadow .3s}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent 10%,rgba(255,255,255,.1) 50%,transparent 90%)}
.card:hover{border-color:rgba(255,255,255,.09);box-shadow:0 8px 40px rgba(0,0,0,.25)}
.card-glow-teal::after{content:'';position:absolute;top:-50px;right:-50px;width:120px;height:120px;background:radial-gradient(circle,rgba(0,201,167,.1),transparent 70%);pointer-events:none}
.card-glow-gold::after{content:'';position:absolute;top:-50px;right:-50px;width:120px;height:120px;background:radial-gradient(circle,rgba(245,200,66,.08),transparent 70%);pointer-events:none}
.card-glow-violet::after{content:'';position:absolute;top:-50px;right:-50px;width:120px;height:120px;background:radial-gradient(circle,rgba(167,139,250,.08),transparent 70%);pointer-events:none}
.card-title{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--text3);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card-icon{width:22px;height:22px;display:flex;align-items:center;justify-content:center;background:var(--surface2);border-radius:6px;font-size:12px}

/* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
.section-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px}
.section-title{font-family:'Playfair Display',serif;font-size:26px;font-weight:700;letter-spacing:-.5px;line-height:1.2;background:linear-gradient(135deg,var(--text) 0%,rgba(200,215,235,.7) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.section-sub{font-size:12px;color:var(--text3);font-family:'DM Mono',monospace;margin-top:3px;letter-spacing:.5px}

/* ‚îÄ‚îÄ HERO CARD ‚îÄ‚îÄ */
.hero-card{background:linear-gradient(135deg,rgba(0,201,167,.06) 0%,rgba(14,165,233,.05) 50%,rgba(139,92,246,.05) 100%);border:1px solid rgba(0,201,167,.14);border-radius:22px;padding:22px 20px;margin-bottom:14px;position:relative;overflow:hidden}
.hero-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--teal),var(--blue),transparent);opacity:.45}
.hero-top{display:flex;align-items:center;gap:20px}
.hero-ring-wrap{position:relative;flex-shrink:0}
.hero-ring-label{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.hero-ring-pct{font-family:'Playfair Display',serif;font-size:24px;font-weight:900;background:linear-gradient(135deg,var(--teal),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.hero-ring-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-top:2px}
.hero-info{flex:1}
.hero-greeting{font-family:'Playfair Display',serif;font-style:italic;font-size:13px;color:var(--text3);margin-bottom:2px}
.hero-name{font-family:'Playfair Display',serif;font-weight:700;font-size:22px;letter-spacing:-.3px;background:linear-gradient(135deg,#e6ecf5,#a8c0d8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);letter-spacing:.5px;margin-top:4px}
.hero-bottom{display:flex;gap:8px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.hms{flex:1;text-align:center;padding:10px 4px;background:var(--surface);border:1px solid var(--border);border-radius:12px;transition:all .2s}
.hms:hover{background:var(--surface2);border-color:rgba(255,255,255,.09)}
.hms-val{font-family:'Playfair Display',serif;font-weight:700;font-size:17px;line-height:1.1;display:block}
.hms-val.ct{background:linear-gradient(135deg,var(--teal),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hms-val.cg{background:linear-gradient(135deg,var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hms-val.cv{background:linear-gradient(135deg,var(--violet),var(--rose));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hms-val.ce{background:linear-gradient(135deg,var(--emerald),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hms-label{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;display:block;margin-top:3px}

/* ‚îÄ‚îÄ JOURNEY CARD ‚îÄ‚îÄ */
.journey-card{background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(245,200,66,.14);border-radius:20px;overflow:hidden;margin-bottom:14px;position:relative}
.journey-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),var(--gold2),transparent);opacity:.55}
.j-header{padding:16px 20px 10px;display:flex;align-items:center;justify-content:space-between}
.j-title{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:var(--text3);display:flex;align-items:center;gap:7px}
.j-pct{font-family:'Playfair Display',serif;font-weight:700;font-size:13px;padding:3px 12px;background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.22);border-radius:20px;color:var(--gold)}
.j-big{display:flex;align-items:baseline;gap:8px;padding:0 20px 14px}
.j-daynum{font-family:'Playfair Display',serif;font-weight:900;font-size:62px;line-height:1;background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 60%,rgba(245,200,66,.5) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 18px rgba(245,200,66,.28));transition:all .4s var(--ease)}
.j-suffix{display:flex;flex-direction:column;gap:2px}
.j-track-wrap{padding:0 20px 16px}
.j-track{height:9px;background:rgba(255,255,255,.04);border-radius:5px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.05)}
.j-fill{height:100%;border-radius:5px;background:linear-gradient(90deg,rgba(0,201,167,.8),var(--gold),rgba(245,200,66,.9));width:0%;transition:width 1.2s var(--ease);position:relative;overflow:hidden}
.j-fill::after{content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.45),transparent);animation:shimmer 2.5s ease infinite}
@keyframes shimmer{0%{left:-60%}100%{left:120%}}
.j-pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;padding:0 14px 14px}
.jp{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 6px;text-align:center;transition:all .2s}
.jp:hover{background:var(--surface2);transform:translateY(-2px)}
.jp-val{font-family:'Playfair Display',serif;font-weight:700;font-size:20px;display:block;line-height:1.1}
.jp-val.c1{color:var(--teal)}.jp-val.c2{color:var(--violet)}.jp-val.c3{color:var(--gold)}.jp-val.c4{color:var(--rose)}
.jp-label{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;display:block;margin-top:2px}
.jp-of{font-family:'DM Mono',monospace;font-size:8px;color:rgba(140,155,175,.2)}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.pw{margin-bottom:11px}
.ph{display:flex;justify-content:space-between;margin-bottom:5px}
.pl{font-size:13px;color:var(--text2)}
.pp{font-family:'DM Mono',monospace;font-size:11px;color:var(--teal)}
.pb{height:5px;background:rgba(255,255,255,.04);border-radius:3px;overflow:hidden}
.pf{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--teal),var(--blue),var(--violet));background-size:200% 100%;transition:width .8s var(--ease);animation:gshift 4s ease infinite}
@keyframes gshift{0%,100%{background-position:0%}50%{background-position:100%}}

/* ‚îÄ‚îÄ HABITS ‚îÄ‚îÄ */
.habit-list{display:flex;flex-direction:column;gap:7px}
.habit-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:14px;cursor:pointer;transition:all .22s;position:relative;overflow:hidden}
.habit-item::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,201,167,.05),transparent);opacity:0;transition:opacity .2s}
.habit-item:hover{background:var(--surface2);border-color:rgba(255,255,255,.09);transform:translateX(2px)}
.habit-item:hover::before{opacity:1}
.habit-item.done{background:rgba(0,201,167,.055);border-color:rgba(0,201,167,.18)}
.habit-item.done::before{opacity:1}
.hc{width:22px;height:22px;border:1.5px solid rgba(255,255,255,.14);border-radius:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .22s;font-size:11px}
.habit-item.done .hc{background:linear-gradient(135deg,var(--teal),var(--blue));border-color:transparent;color:#000;box-shadow:0 0 12px rgba(0,201,167,.35)}
.hname{flex:1;font-size:14px}
.hstreak{font-family:'DM Mono',monospace;font-size:11px;color:var(--gold);background:rgba(245,200,66,.08);padding:2px 7px;border-radius:10px;border:1px solid rgba(245,200,66,.14)}
.icon-btn{width:26px;height:26px;display:flex;align-items:center;justify-content:center;background:var(--surface);border:1px solid var(--border);border-radius:7px;cursor:pointer;font-size:11px;color:var(--text3);transition:all .2s}
.icon-btn:hover{color:var(--rose);border-color:rgba(251,113,133,.3);background:rgba(251,113,133,.06)}

/* ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ */
.goal-item{background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:12px;transition:all .22s;position:relative;overflow:hidden}
.goal-item::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.07),transparent)}
.goal-item:hover{border-color:rgba(255,255,255,.1);box-shadow:0 6px 30px rgba(0,0,0,.2)}
.goal-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
.goal-title{font-family:'Playfair Display',serif;font-weight:700;font-size:17px;letter-spacing:-.2px}
.goal-badge{padding:3px 10px;border-radius:20px;font-size:9px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:1.5px;flex-shrink:0;margin-left:8px}
.badge-work{background:rgba(56,189,248,.1);color:var(--blue);border:1px solid rgba(56,189,248,.2)}
.badge-personal{background:rgba(167,139,250,.1);color:var(--violet);border:1px solid rgba(167,139,250,.2)}
.badge-health{background:rgba(52,211,153,.1);color:var(--emerald);border:1px solid rgba(52,211,153,.2)}
.badge-finance{background:rgba(245,200,66,.1);color:var(--gold);border:1px solid rgba(245,200,66,.2)}
.goal-meta{font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;margin-bottom:12px;letter-spacing:.3px}
.goal-actions{display:flex;gap:6px;margin-top:14px;flex-wrap:wrap}
.gin{width:70px;padding:7px 10px;background:var(--surface);border:1px solid var(--border);border-radius:9px;color:var(--text);font-size:13px;outline:none;text-align:center;font-family:'DM Mono',monospace;transition:border-color .2s}
.gin:focus{border-color:var(--teal)}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);background:rgba(5,8,16,.9);backdrop-filter:blur(32px) saturate(1.8);-webkit-backdrop-filter:blur(32px);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom,0px)}
nav::before{content:'';position:absolute;top:0;left:5%;right:5%;height:1px;background:linear-gradient(90deg,transparent,rgba(0,201,167,.28),rgba(56,189,248,.28),rgba(139,92,246,.28),transparent)}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;cursor:pointer;transition:all .25s;padding:6px 2px;position:relative}
.nav-icon{font-size:20px;transition:transform .25s var(--ease),filter .25s}
.nav-label{font-size:9px;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;font-family:'DM Mono',monospace;transition:color .2s}
.nav-item.active .nav-label{color:var(--teal)}
.nav-item.active .nav-icon{transform:translateY(-3px);filter:drop-shadow(0 0 6px var(--teal))}
.nav-item.active::after{content:'';position:absolute;bottom:6px;left:50%;transform:translateX(-50%);width:4px;height:4px;background:var(--teal);border-radius:50%;box-shadow:0 0 8px var(--teal)}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border-radius:10px;font-size:13px;font-weight:500;cursor:pointer;transition:all .22s;border:none;font-family:'DM Sans',sans-serif}
.btn-primary{background:linear-gradient(135deg,var(--teal),var(--blue));color:#fff;font-weight:600;box-shadow:0 2px 16px rgba(0,201,167,.22)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(0,201,167,.38)}
.btn-ghost{background:var(--surface);border:1px solid var(--border);color:var(--text2)}
.btn-ghost:hover{border-color:rgba(255,255,255,.14);color:var(--text);background:var(--surface2)}
.btn-danger{background:rgba(251,113,133,.08);border:1px solid rgba(251,113,133,.2);color:var(--rose)}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.input{width:100%;padding:10px 14px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color .2s,box-shadow .2s;appearance:none}
.input:focus{border-color:rgba(0,201,167,.45);box-shadow:0 0 0 3px rgba(0,201,167,.07)}
.input::placeholder{color:var(--text3)}
.fg{margin-bottom:14px}
.fl{display:block;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:7px;font-family:'DM Mono',monospace}

/* ‚îÄ‚îÄ WEEK ‚îÄ‚îÄ */
.week-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.week-label{font-family:'Playfair Display',serif;font-weight:700;font-size:16px}
.chevron{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:var(--surface);border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:all .2s;color:var(--text2)}
.chevron:hover{border-color:var(--teal);color:var(--teal);box-shadow:0 0 10px rgba(0,201,167,.14)}
.week-days{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.week-day{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer;transition:all .2s;min-height:76px;display:flex;flex-direction:column;align-items:center;gap:4px}
.week-day:hover{border-color:rgba(255,255,255,.11);background:var(--surface2)}
.week-day.today{border-color:rgba(245,200,66,.38);box-shadow:0 0 12px rgba(245,200,66,.09) inset}
.wday-label{font-size:8px;color:var(--text3);text-transform:uppercase;font-family:'DM Mono',monospace;letter-spacing:.5px}
.wday-num{font-family:'Playfair Display',serif;font-weight:700;font-size:17px}
.wday-dots{display:flex;gap:2px;flex-wrap:wrap;justify-content:center}
.wd{width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,.07)}
.wd.done{background:var(--emerald);box-shadow:0 0 4px var(--emerald)}
.wday-score{font-family:'DM Mono',monospace;font-size:9px}

/* ‚îÄ‚îÄ YEAR MAP ‚îÄ‚îÄ */
.year-grid{display:grid;grid-template-columns:repeat(52,1fr);gap:2px;overflow-x:auto;padding-bottom:4px}
.yc{aspect-ratio:1;min-width:10px;border-radius:2px;background:rgba(255,255,255,.03);cursor:pointer;transition:all .15s}
.yc:hover{transform:scale(1.5);z-index:2}
.yc.l1{background:rgba(0,201,167,.18)}.yc.l2{background:rgba(0,201,167,.38)}.yc.l3{background:rgba(0,201,167,.62)}.yc.l4{background:var(--teal);box-shadow:0 0 4px rgba(0,201,167,.5)}
.yc.today{outline:1.5px solid var(--gold);outline-offset:1px;border-radius:3px}
.year-label{font-family:'Playfair Display',serif;font-style:italic;font-size:14px;color:var(--text2);margin:14px 0 7px}

/* ‚îÄ‚îÄ MONTH ‚îÄ‚îÄ */
.month-nav{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.month-title{font-family:'Playfair Display',serif;font-weight:700;font-size:18px;flex:1;text-align:center}
.mh{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:3px}
.mh span{text-align:center;font-size:9px;color:var(--text3);font-family:'DM Mono',monospace;padding:4px;letter-spacing:.5px}
.mgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.dc{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:9px;font-size:12px;cursor:pointer;transition:all .15s;background:var(--surface);border:1px solid var(--border);position:relative;font-family:'DM Mono',monospace}
.dc:hover{border-color:rgba(0,201,167,.38);color:var(--teal)}
.dc.today{background:rgba(0,201,167,.1);border-color:var(--teal);color:var(--teal);font-weight:600;box-shadow:0 0 10px rgba(0,201,167,.13) inset}
.dc.has-data::after{content:'';position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:3px;height:3px;border-radius:50%;background:var(--gold)}
.dc.empty{background:transparent;border-color:transparent;cursor:default}
.dc.done{background:rgba(52,211,153,.08);border-color:rgba(52,211,153,.2);color:var(--emerald)}

/* ‚îÄ‚îÄ TIME BLOCKS ‚îÄ‚îÄ */
.tbgrid{display:flex;flex-direction:column;gap:6px}
/* Empty slot ‚Äî single line */
.ts-empty{display:flex;align-items:center;gap:10px;padding:9px 14px;background:var(--surface);border:1px dashed rgba(255,255,255,.06);border-radius:12px;cursor:pointer;transition:all .2s;opacity:.6}
.ts-empty:hover{opacity:1;border-color:rgba(0,201,167,.3);background:rgba(0,201,167,.03)}
.ts-empty .tl{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);width:38px;flex-shrink:0}
.ts-empty .tt{font-size:12px;color:var(--text3);font-style:italic}
/* Booked slot ‚Äî 2-line card */
.ts-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:all .2s}
.ts-card:hover{border-color:rgba(255,255,255,.1)}
.ts-card.s-todo   {border-left:3px solid rgba(0,201,167,.4)}
.ts-card.s-inprogress{border-left:3px solid var(--blue);background:rgba(56,189,248,.03)}
.ts-card.s-done   {border-left:3px solid var(--emerald);background:rgba(52,211,153,.03)}
/* Top row: time + task + edit */
.ts-top{display:flex;align-items:center;gap:10px;padding:10px 14px 6px}
.tl{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);flex-shrink:0;width:38px}
.tt{font-size:14px;font-weight:400;flex:1;min-width:0;line-height:1.4}
.ts-card.s-done .tt{text-decoration:line-through;color:var(--text3)}
.ts-editbtn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:13px;color:var(--text3);flex-shrink:0;transition:all .18s;border:1px solid transparent}
.ts-editbtn:hover{color:var(--text2);background:var(--surface2);border-color:var(--border)}
/* Bottom row: category + STATUS SELECT */
.ts-bottom{display:flex;align-items:center;gap:8px;padding:0 14px 10px;padding-left:60px}
.ts-cat{font-family:'DM Mono',monospace;font-size:10px;color:var(--text3);flex:1}
/* STATUS TAB BUTTONS */
.ts-status-tabs{display:flex;gap:4px}
.ts-stab{padding:4px 10px;border-radius:16px;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;
  border:1.5px solid rgba(255,255,255,.08);color:var(--text3);background:transparent;
  cursor:pointer;transition:all .18s;white-space:nowrap;-webkit-appearance:none;appearance:none;outline:none}
.ts-stab:active{transform:scale(.95)}
.ts-stab.active-todo      {color:#fff;border-color:rgba(0,201,167,.5);background:rgba(0,201,167,.15)}
.ts-stab.active-inprogress{color:var(--blue);border-color:rgba(56,189,248,.5);background:rgba(56,189,248,.15);box-shadow:0 0 8px rgba(56,189,248,.2)}
.ts-stab.active-done      {color:var(--emerald);border-color:rgba(52,211,153,.5);background:rgba(52,211,153,.15);box-shadow:0 0 8px rgba(52,211,153,.2)}
/* Daily wins summary */
.wins-card{background:linear-gradient(135deg,rgba(52,211,153,.06) 0%,rgba(0,201,167,.04) 100%);border:1px solid rgba(52,211,153,.18);border-radius:18px;padding:18px 20px;margin-bottom:14px;position:relative;overflow:hidden}
.wins-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--emerald),var(--teal),transparent);opacity:.45}
.wins-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.wins-stat{text-align:center;padding:10px 6px;background:var(--surface);border:1px solid var(--border);border-radius:12px}
.wins-val{font-family:'Playfair Display',serif;font-weight:700;font-size:22px;display:block;line-height:1.1}
.wins-lbl{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;display:block;margin-top:3px}
.wins-task-row{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;margin-bottom:4px;background:var(--surface)}
.wins-task-done{background:rgba(52,211,153,.06);border:1px solid rgba(52,211,153,.15)}
.wins-task-ip{background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.2)}

/* ‚îÄ‚îÄ TAGS ‚îÄ‚îÄ */
.tag-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.tag{padding:5px 13px;border-radius:20px;font-size:11px;font-family:'DM Mono',monospace;border:1px solid var(--border);color:var(--text3);cursor:pointer;transition:all .18s;letter-spacing:.3px}
.tag:hover{border-color:rgba(255,255,255,.11);color:var(--text2)}
.tag.active{border-color:rgba(0,201,167,.38);color:var(--teal);background:rgba(0,201,167,.08)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:1000;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex;animation:fadeO .22s ease}
@keyframes fadeO{from{opacity:0}to{opacity:1}}
.modal{background:rgba(9,13,22,.96);backdrop-filter:blur(30px);border:1px solid rgba(255,255,255,.09);border-radius:24px 24px 0 0;padding:26px 22px 44px;width:100%;max-width:480px;animation:modalUp .32s var(--ease) both;max-height:88vh;overflow-y:auto;position:relative}
.modal::before{content:'';position:absolute;top:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,rgba(0,201,167,.38),transparent)}
@media(min-width:600px){.modal-overlay{align-items:center}.modal{border-radius:24px;max-height:80vh}}
@keyframes modalUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-family:'Playfair Display',serif;font-weight:700;font-size:22px;margin-bottom:22px;letter-spacing:-.3px}
.modal-handle{width:36px;height:3px;background:rgba(255,255,255,.1);border-radius:2px;margin:-8px auto 22px}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:22px}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:82px;left:50%;transform:translateX(-50%);background:rgba(10,14,24,.92);backdrop-filter:blur(16px);border:1px solid rgba(0,201,167,.22);color:var(--text);padding:10px 20px;border-radius:20px;font-size:13px;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s,transform .3s;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.4)}
#toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:36px 20px;color:var(--text3)}
.empty-state .ei{font-size:36px;margin-bottom:10px}
.empty-state p{font-size:13px;line-height:1.7}
.gauth-info{background:rgba(14,165,233,.06);border:1px solid rgba(14,165,233,.14);border-radius:12px;padding:16px;margin-bottom:14px;font-size:13px;line-height:1.8;color:var(--text2)}
.gauth-info strong{color:var(--blue);display:block;margin-bottom:4px;font-family:'Playfair Display',serif;font-style:italic}
code{background:var(--surface2);border:1px solid var(--border);padding:2px 7px;border-radius:5px;font-family:'DM Mono',monospace;font-size:11px;color:var(--teal)}
.mt8{margin-top:8px}.mt16{margin-top:16px}
.text-muted{color:var(--text3);font-size:12px}

/* ‚îÄ‚îÄ RESPONSIVE DESKTOP ‚îÄ‚îÄ */
@media(min-width:640px){
  #app{flex-direction:row}
  nav{position:sticky;flex-direction:column;width:78px;height:100vh;height:100dvh;border-top:none;border-right:1px solid var(--border);padding:16px 0}
  nav::before{top:0;left:auto;right:0;bottom:0;width:1px;height:auto;background:linear-gradient(180deg,transparent,rgba(0,201,167,.25),rgba(56,189,248,.25),transparent)}
  .nav-item{flex:none;height:66px;width:100%}
  .nav-item.active::after{top:50%;left:0;bottom:auto;right:auto;transform:translateY(-50%);width:3px;height:28px;border-radius:0 3px 3px 0}
  main{flex:1}
  .view{max-width:680px;margin:0 auto;padding:28px 24px 40px}
}
</style>
</head>
<body>

<!-- COSMOS -->
<div id="cosmos">
  <canvas id="starCanvas"></canvas>
  <div class="orb o1"></div><div class="orb o2"></div>
  <div class="orb o3"></div><div class="orb o4"></div>
</div>
<div class="grain"></div>

<div id="app">
  <header>
    <div class="logo">APEX</div>
    <div class="header-right">
      <div class="streak-chip" id="streakChip">üî• 0d</div>
      <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle light/dark mode">üåô</div>
      <div class="sync-btn" id="syncBtn" onclick="handleSync()">
        <span>‚ü≥</span><span id="syncLabel">Sync</span>
      </div>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <div class="view active" id="view-dashboard">
      <!-- Hero -->
      <div class="hero-card">
        <div class="hero-top">
          <div class="hero-ring-wrap">
            <svg width="88" height="88" viewBox="0 0 88 88">
              <circle cx="44" cy="44" r="37" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="7"/>
              <circle cx="44" cy="44" r="37" fill="none" stroke="url(#rg)" stroke-width="7"
                stroke-linecap="round" stroke-dasharray="233" stroke-dashoffset="233"
                transform="rotate(-90 44 44)" id="heroRing" style="transition:stroke-dashoffset 1.2s cubic-bezier(0.16,1,0.3,1)"/>
              <defs><linearGradient id="rg" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#00c9a7"/><stop offset="100%" stop-color="#38bdf8"/></linearGradient></defs>
            </svg>
            <div class="hero-ring-label">
              <span class="hero-ring-pct" id="heroRingPct">0%</span>
              <span class="hero-ring-sub">today</span>
            </div>
          </div>
          <div class="hero-info">
            <div class="hero-greeting" id="greetingText">Good morning,</div>
            <div class="hero-name" id="heroName">Prabhanjan</div>
            <div class="hero-date" id="todayDate"></div>
          </div>
        </div>
        <div class="hero-bottom">
          <div class="hms"><span class="hms-val ct" id="hms7avg">0%</span><span class="hms-label">7d avg</span></div>
          <div class="hms"><span class="hms-val cg" id="hmsStreak">0d</span><span class="hms-label">streak</span></div>
          <div class="hms"><span class="hms-val cv" id="hmsGoals">0</span><span class="hms-label">goals</span></div>
          <div class="hms"><span class="hms-val ce" id="hmsConsistency">0%</span><span class="hms-label">30d habit</span></div>
        </div>
      </div>

      <!-- 2-Year Journey -->
      <div class="journey-card">
        <div class="j-header">
          <div class="j-title"><span>‚ú¶</span> 2-Year Journey</div>
          <div class="j-pct" id="yr2PctBadge">0%</div>
        </div>
        <div class="j-big">
          <div class="j-daynum" id="yr2DayNum">1</div>
          <div class="j-suffix">
            <span style="font-family:'Playfair Display',serif;font-style:italic;color:var(--text3);font-size:14px">of 730 days</span>
            <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text3)" id="yr2DateRange">‚Äî</span>
          </div>
        </div>
        <div class="j-track-wrap">
          <div class="j-track"><div class="j-fill" id="yr2Bar"></div></div>
          <div style="display:flex;justify-content:space-between;margin-top:6px">
            <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3)" id="yr2StartLabel">‚Äî</span>
            <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3)" id="yr2EndLabel">‚Äî</span>
          </div>
        </div>
        <div class="j-pillars">
          <div class="jp"><span class="jp-val c1" id="yr2Week">‚Äî</span><span class="jp-label">Week</span><span class="jp-of">/ 104</span></div>
          <div class="jp"><span class="jp-val c2" id="yr2Month">‚Äî</span><span class="jp-label">Month</span><span class="jp-of">/ 24</span></div>
          <div class="jp"><span class="jp-val c3" id="yr2Quarter">‚Äî</span><span class="jp-label">Quarter</span><span class="jp-of">/ 8</span></div>
          <div class="jp"><span class="jp-val c4" id="yr2Year">‚Äî</span><span class="jp-label">Year</span><span class="jp-of">/ 2</span></div>
        </div>
      </div>

      <!-- Progress -->
      <div class="card card-glow-teal">
        <div class="card-title"><div class="card-icon">üìä</div> Progress Overview</div>
        <div id="progressRates"></div>
      </div>

      <!-- Habits mini -->
      <div class="card card-glow-violet">
        <div class="card-title"><div class="card-icon">‚úÖ</div> Today's Habits</div>
        <div id="dashHabits"></div>
      </div>

      <!-- Goals mini -->
      <div class="card card-glow-gold">
        <div class="card-title"><div class="card-icon">üéØ</div> Active Goals</div>
        <div id="dashGoals"></div>
      </div>
    </div>

    <!-- DAILY -->
    <div class="view" id="view-daily">
      <div class="section-header">
        <div><div class="section-title">Daily Tracker</div><div class="section-sub" id="dailyDate"></div></div>
        <button class="btn btn-primary" onclick="openAddHabit()">+ Habit</button>
      </div>
      <div class="card">
        <div class="card-title"><div class="card-icon">üåÖ</div> Habits</div>
        <div id="habitList" class="habit-list"></div>
        <div class="mt16">
          <div class="pw"><div class="ph"><span class="pl">Today's Completion</span><span class="pp" id="dailyPct">0%</span></div><div class="pb"><div class="pf" id="dailyBar" style="width:0%"></div></div></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><div class="card-icon">üïê</div> Time Blocks</div>
        <div class="tbgrid" id="timeBlocks"></div>
      </div>
      <div class="wins-card" id="dailyWinsCard">
        <div class="card-title" style="margin-bottom:14px"><div class="card-icon">üèÜ</div> Today's Task Summary</div>
        <div class="wins-row">
          <div class="wins-stat"><span class="wins-val" id="winsTotal" style="color:var(--text2)">0</span><span class="wins-lbl">Total</span></div>
          <div class="wins-stat"><span class="wins-val" id="winsIP" style="color:var(--blue)">0</span><span class="wins-lbl">In Progress</span></div>
          <div class="wins-stat"><span class="wins-val" id="winsDone" style="color:var(--emerald)">0</span><span class="wins-lbl">Completed</span></div>
        </div>
        <div id="winsList"></div>
      </div>
      <div class="card">
        <div class="card-title"><div class="card-icon">üìù</div> Daily Notes</div>
        <textarea class="input" id="dailyNotes" rows="4" placeholder="Key wins, challenges, reflections..." onblur="saveDailyNotes()" style="resize:none;line-height:1.7"></textarea>
      </div>
    </div>

    <!-- WEEKLY -->
    <div class="view" id="view-weekly">
      <div class="section-header"><div><div class="section-title">Weekly</div><div class="section-sub">2-Year Overview</div></div></div>
      <div class="card">
        <div class="week-nav"><div class="chevron" onclick="changeWeek(-1)">‚Äπ</div><span class="week-label" id="weekLabel"></span><div class="chevron" onclick="changeWeek(1)">‚Ä∫</div></div>
        <div class="week-days" id="weekDays"></div>
      </div>
      <div class="card"><div class="card-title"><div class="card-icon">üìã</div> Week Summary</div><div id="weekSummary"></div></div>
      <div class="card card-glow-gold"><div class="card-title"><div class="card-icon">‚è≥</div> Pending Tasks</div><div id="pendingTasks"></div></div>
      <div class="card"><div class="card-title"><div class="card-icon">üóìÔ∏è</div> 2-Year Activity Map</div><div id="yearMaps"></div></div>
    </div>

    <!-- MONTHLY -->
    <div class="view" id="view-monthly">
      <div class="section-header"><div><div class="section-title">Monthly</div><div class="section-sub">Activity & Consistency</div></div></div>
      <div class="card">
        <div class="month-nav"><div class="chevron" onclick="changeMonth(-1)">‚Äπ</div><div class="month-title" id="monthTitle"></div><div class="chevron" onclick="changeMonth(1)">‚Ä∫</div></div>
        <div class="mh"><span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span></div>
        <div class="mgrid" id="monthGrid"></div>
      </div>
      <div class="card"><div class="card-title"><div class="card-icon">üìà</div> Monthly Stats</div><div id="monthlyStats"></div></div>
      <div class="card"><div class="card-title"><div class="card-icon">üîÑ</div> Habit Consistency</div><div id="habitConsistency"></div></div>
    </div>

    <!-- GOALS -->
    <div class="view" id="view-goals">
      <div class="section-header">
        <div><div class="section-title">Goals</div><div class="section-sub">2-Year Roadmap</div></div>
        <button class="btn btn-primary" onclick="openAddGoal()">+ Goal</button>
      </div>
      <div class="tag-row" id="goalFilter">
        <div class="tag active" onclick="filterGoals('all',this)">All</div>
        <div class="tag" onclick="filterGoals('work',this)">Work</div>
        <div class="tag" onclick="filterGoals('personal',this)">Personal</div>
        <div class="tag" onclick="filterGoals('health',this)">Health</div>
        <div class="tag" onclick="filterGoals('finance',this)">Finance</div>
      </div>
      <div id="goalsList"></div>
    </div>

    <!-- SETTINGS -->
    <div class="view" id="view-settings">
      <div class="section-header"><div><div class="section-title">Settings</div><div class="section-sub">Sync & Preferences</div></div></div>
      <div class="card">
        <div class="card-title"><div class="card-icon">‚òÅÔ∏è</div> Google Drive Sync</div>
        <div class="gauth-info"><strong>Setup Instructions</strong>1. Go to <code>console.cloud.google.com</code><br>2. Create project ‚Üí Enable <code>Google Drive API</code><br>3. Create OAuth 2.0 Web Client ID<br>4. Add your GitHub Pages URL to Authorized Origins<br>5. Paste Client ID below</div>
        <div class="fg"><label class="fl">Google Client ID</label><input class="input" id="clientIdInput" placeholder="xxxxxxxx.apps.googleusercontent.com" oninput="saveClientId()"></div>
        <div id="authArea" class="mt8"></div>
      </div>
      <div class="card">
        <div class="card-title"><div class="card-icon">üíæ</div> Data Management</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-ghost" style="justify-content:flex-start" onclick="exportData()">üì§ Export as JSON</button>
          <button class="btn btn-ghost" style="justify-content:flex-start" onclick="importTrigger()">üì• Import JSON</button>
          <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
          <button class="btn btn-danger" style="justify-content:flex-start" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title"><div class="card-icon">‚öôÔ∏è</div> Preferences</div>
        <div class="fg"><label class="fl">Your Name</label><input class="input" id="userName" placeholder="Prabhanjan" oninput="savePrefs()"></div>
        <div class="fg"><label class="fl">2-Year Journey Start Date</label><input type="date" class="input" id="journeyStart" onchange="savePrefs()"><div class="text-muted mt8">Changing this resets the day counter.</div></div>
        <div class="fg"><label class="fl">Work Start Time</label><input type="time" class="input" id="workStart" value="09:00" onchange="savePrefs()"></div>
        <div class="fg"><label class="fl">Work End Time</label><input type="time" class="input" id="workEnd" value="18:00" onchange="savePrefs()"></div>
        <div class="fg"><label class="fl">Daily Goal Target (%)</label><input type="number" class="input" id="dailyTarget" min="50" max="100" value="80" onchange="savePrefs()"></div>
      </div>
      <div class="card">
        <div class="card-title"><div class="card-icon">üì±</div> Install as App</div>
        <p style="color:var(--text2);font-size:13px;margin-bottom:12px;line-height:1.7">Install APEX on your device for the best native experience.</p>
        <button class="btn btn-primary" onclick="installApp()" id="installBtn">üì≤ Install App</button>
        <p class="text-muted mt8">iOS: Safari ‚Üí Share ‚Üí Add to Home Screen</p>
      </div>
    </div>
  </main>

  <nav>
    <div class="nav-item active" onclick="switchView('dashboard',this)"><div class="nav-icon">üè†</div><div class="nav-label">Home</div></div>
    <div class="nav-item" onclick="switchView('daily',this)"><div class="nav-icon">‚úÖ</div><div class="nav-label">Daily</div></div>
    <div class="nav-item" onclick="switchView('weekly',this)"><div class="nav-icon">üìÖ</div><div class="nav-label">Weekly</div></div>
    <div class="nav-item" onclick="switchView('monthly',this)"><div class="nav-icon">üóìÔ∏è</div><div class="nav-label">Monthly</div></div>
    <div class="nav-item" onclick="switchView('goals',this)"><div class="nav-icon">üéØ</div><div class="nav-label">Goals</div></div>
    <div class="nav-item" onclick="switchView('settings',this)"><div class="nav-icon">‚öôÔ∏è</div><div class="nav-label">Sync</div></div>
  </nav>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="habitModal">
  <div class="modal"><div class="modal-handle"></div><div class="modal-title" id="habitModalTitle">Add Habit</div>
    <div class="fg"><label class="fl">Habit Name</label><input class="input" id="habitName" placeholder="e.g. Morning Exercise"></div>
    <div class="fg"><label class="fl">Icon (Emoji)</label><input class="input" id="habitIcon" placeholder="üí™" maxlength="2" style="font-size:20px"></div>
    <div class="fg"><label class="fl">Category</label><select class="input" id="habitCategory"><option value="health">Health & Fitness</option><option value="work">Work & Career</option><option value="learning">Learning</option><option value="mindfulness">Mindfulness</option><option value="social">Social</option><option value="other">Other</option></select></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('habitModal')">Cancel</button><button class="btn btn-primary" onclick="saveHabit()">Save Habit</button></div>
  </div>
</div>
<div class="modal-overlay" id="goalModal">
  <div class="modal"><div class="modal-handle"></div><div class="modal-title">Set New Goal</div>
    <div class="fg"><label class="fl">Goal Title</label><input class="input" id="goalTitle" placeholder="e.g. Get OCI Certified"></div>
    <div class="fg"><label class="fl">Category</label><select class="input" id="goalCategory"><option value="work">Work & Career</option><option value="personal">Personal</option><option value="health">Health & Fitness</option><option value="finance">Finance</option></select></div>
    <div class="fg"><label class="fl">Target (number)</label><input class="input" id="goalTarget" type="number" placeholder="100" min="1"></div>
    <div class="fg"><label class="fl">Unit (e.g. hours, %, tasks)</label><input class="input" id="goalUnit" placeholder="hours"></div>
    <div class="fg"><label class="fl">Deadline</label><input type="date" class="input" id="goalDeadline"></div>
    <div class="fg"><label class="fl">Description</label><textarea class="input" id="goalDesc" rows="2" placeholder="Why this goal matters..."></textarea></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('goalModal')">Cancel</button><button class="btn btn-primary" onclick="saveGoal()">Set Goal</button></div>
  </div>
</div>
<div class="modal-overlay" id="timeModal">
  <div class="modal"><div class="modal-handle"></div><div class="modal-title" id="timeModalTitle">Book Time Slot</div>
    <div class="fg"><label class="fl">Task / Activity</label><input class="input" id="timeTask" placeholder="e.g. Deep Work - OCI Study"></div>
    <div class="fg"><label class="fl">Category</label><select class="input" id="timeCategory"><option value="deep-work">üß† Deep Work</option><option value="meeting">ü§ù Meeting</option><option value="exercise">üí™ Exercise</option><option value="learning">üìö Learning</option><option value="personal">üè† Personal</option></select></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('timeModal')">Cancel</button><button class="btn btn-primary" onclick="saveTimeBlock()">Book Slot</button></div>
  </div>
</div>
<div class="modal-overlay" id="dayModal">
  <div class="modal"><div class="modal-handle"></div><div class="modal-title" id="dayModalTitle">Day Details</div><div id="dayModalContent"></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('dayModal')">Close</button></div>
  </div>
</div>
<div id="toast"></div>

<script>
/* ‚îÄ‚îÄ STARFIELD ‚îÄ‚îÄ */
(function(){
  const c=document.getElementById('starCanvas'),ctx=c.getContext('2d');let stars=[];
  function resize(){c.width=window.innerWidth;c.height=window.innerHeight}
  function mk(){return{x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.2+.2,a:Math.random(),da:(Math.random()-.5)*.004}}
  function boot(){resize();stars=Array.from({length:160},mk)}
  function draw(){ctx.clearRect(0,0,c.width,c.height);stars.forEach(s=>{s.a=Math.max(.05,Math.min(.9,s.a+s.da));if(s.a<=.05||s.a>=.9)s.da*=-1;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle=`rgba(200,220,255,${s.a})`;ctx.fill()});requestAnimationFrame(draw)}
  window.addEventListener('resize',boot);boot();draw();
})();

/* ‚îÄ‚îÄ DATA ‚îÄ‚îÄ */
let DB={habits:[],dailyLogs:{},goals:[],timeBlocks:{},prefs:{name:'Prabhanjan',workStart:'09:00',workEnd:'18:00',dailyTarget:80},googleToken:null,driveFileId:null};
const TODAY=new Date();
let currentWeekOffset=0,currentMonthDate=new Date(),activeGoalFilter='all',editingHabitId=null,editingTimeSlot=null,deferredInstall=null;

window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredInstall=e;document.getElementById('installBtn').textContent='üì≤ Install Now'});
function installApp(){if(deferredInstall){deferredInstall.prompt();deferredInstall.userChoice.then(r=>{if(r.outcome==='accepted')showToast('Installing...')})}else showToast('Browser menu ‚Üí Add to Home Screen')}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
function init(){loadData();seedDefaultHabits();initTheme();renderAll();updateStreak();initGoogleAPI()}

function loadData(){
  try{const s=localStorage.getItem('apex_data');if(s)DB={...DB,...JSON.parse(s)}}catch(e){}
  const p=DB.prefs,q=id=>document.getElementById(id);
  if(q('userName'))q('userName').value=p.name||'';
  if(q('workStart'))q('workStart').value=p.workStart||'09:00';
  if(q('workEnd'))q('workEnd').value=p.workEnd||'18:00';
  if(q('dailyTarget'))q('dailyTarget').value=p.dailyTarget||80;
  const cid=localStorage.getItem('apex_client_id');
  if(cid&&q('clientIdInput'))q('clientIdInput').value=cid;
  if(q('journeyStart'))q('journeyStart').value=p.journeyStart||dateStr(new Date());
}

function saveData(){localStorage.setItem('apex_data',JSON.stringify(DB))}

function seedDefaultHabits(){
  if(DB.habits.length===0){
    DB.habits=[
      {id:uid(),name:'Morning Exercise',icon:'üí™',category:'health',createdAt:dateStr(TODAY),streak:0},
      {id:uid(),name:'Read / Learn',icon:'üìö',category:'learning',createdAt:dateStr(TODAY),streak:0},
      {id:uid(),name:'Deep Work Block',icon:'üß†',category:'work',createdAt:dateStr(TODAY),streak:0},
      {id:uid(),name:'Meditation',icon:'üßò',category:'mindfulness',createdAt:dateStr(TODAY),streak:0},
    ];
    saveData();
  }
}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
function switchView(name,el){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  el.classList.add('active');
  if(name==='dashboard')renderDashboard();
  else if(name==='daily')renderDaily();
  else if(name==='weekly')renderWeekly();
  else if(name==='monthly')renderMonthly();
  else if(name==='goals')renderGoals();
}

/* ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ */
function toggleTheme(){
  const isLight = document.documentElement.classList.toggle('light');
  const btn = document.getElementById('themeToggle');
  if(btn) btn.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  // Update meta theme-color
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta) meta.content = isLight ? '#f0f2f8' : '#05080f';
  // Persist
  localStorage.setItem('apex_theme', isLight ? 'light' : 'dark');
}

function initTheme(){
  const saved = localStorage.getItem('apex_theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const useDark = saved ? saved === 'dark' : prefersDark;
  if(!useDark){
    document.documentElement.classList.add('light');
    const btn = document.getElementById('themeToggle');
    if(btn) btn.textContent = '‚òÄÔ∏è';
    const meta = document.querySelector('meta[name="theme-color"]');
    if(meta) meta.content = '#f0f2f8';
  }
}

function renderAll(){setGreeting();renderDashboard();renderDaily()}

/* ‚îÄ‚îÄ GREETING ‚îÄ‚îÄ */
function setGreeting(){
  const h=new Date().getHours();
  document.getElementById('greetingText').textContent=h<12?'Good morning,':h<17?'Good afternoon,':'Good evening,';
  document.getElementById('heroName').textContent=DB.prefs.name||'Friend';
  const ds=new Date().toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('todayDate').textContent=ds;
  const dd=document.getElementById('dailyDate');if(dd)dd.textContent=ds;
}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
function renderDashboard(){
  const k=dateStr(TODAY),log=DB.dailyLogs[k]||{};
  const done=DB.habits.filter(h=>log[h.id]).length,total=DB.habits.length;
  const pct=total?Math.round(done/total*100):0;

  // Ring animation
  const ring=document.getElementById('heroRing');
  if(ring){const off=233-(pct/100)*233;requestAnimationFrame(()=>requestAnimationFrame(()=>ring.style.strokeDashoffset=off))}
  document.getElementById('heroRingPct').textContent=pct+'%';

  // 7d avg
  let w7=0;
  for(let i=0;i<7;i++){const d=new Date(TODAY);d.setDate(d.getDate()-i);const l=DB.dailyLogs[dateStr(d)]||{};w7+=total?DB.habits.filter(h=>l[h.id]).length/total*100:0}
  w7=Math.round(w7/7);

  const streak=calcStreak(),activeGoals=DB.goals.filter(g=>!g.completed).length,cons=calcHabitConsistency30();
  document.getElementById('hms7avg').textContent=w7+'%';
  document.getElementById('hmsStreak').textContent=streak+'d';
  document.getElementById('hmsGoals').textContent=activeGoals;
  document.getElementById('hmsConsistency').textContent=cons+'%';

  renderTwoYearCounter();

  document.getElementById('progressRates').innerHTML=[
    {label:'Daily Target',val:pct},
    {label:'Weekly Average',val:w7},
    {label:'Goal Completion',val:calcGoalAvgProgress()},
    {label:'Habit Consistency (30d)',val:cons}
  ].map(r=>`<div class="pw"><div class="ph"><span class="pl">${r.label}</span><span class="pp">${r.val}%</span></div><div class="pb"><div class="pf" style="width:${r.val}%"></div></div></div>`).join('');

  document.getElementById('dashHabits').innerHTML=!DB.habits.length
    ?'<div class="empty-state"><div class="ei">üå±</div><p>Add habits in the Daily tab</p></div>'
    :DB.habits.slice(0,5).map(h=>{const d=!!(log[h.id]);return`<div class="habit-item ${d?'done':''}" onclick="quickToggle('${h.id}')"><div class="hc">${d?'‚úì':''}</div><span style="font-size:18px">${h.icon}</span><div class="hname">${h.name}</div><div class="hstreak">üî•${h.streak||0}</div></div>`}).join('');

  const ag=DB.goals.filter(g=>!g.completed).slice(0,3);
  document.getElementById('dashGoals').innerHTML=!ag.length
    ?'<div class="empty-state"><p>No active goals yet</p></div>'
    :ag.map(g=>{const p=Math.min(100,Math.round((g.progress||0)/g.target*100));return`<div class="pw" style="margin-top:8px"><div class="ph"><span class="pl">${g.icon||'üéØ'} ${g.title}</span><span class="pp">${p}%</span></div><div class="pb"><div class="pf" style="width:${p}%"></div></div></div>`}).join('');
}

/* ‚îÄ‚îÄ 2-YEAR COUNTER ‚îÄ‚îÄ */
function renderTwoYearCounter(){
  if(!DB.prefs.journeyStart){DB.prefs.journeyStart=dateStr(TODAY);saveData()}
  const start=new Date(DB.prefs.journeyStart+'T00:00:00');
  const end=new Date(start);end.setFullYear(end.getFullYear()+2);
  const now=new Date();now.setHours(0,0,0,0);
  const elapsed=Math.max(0,Math.min(730,Math.floor((now-start)/86400000)+1));
  const pct=Math.round(elapsed/730*100);
  const fmt=d=>d.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'2-digit'});
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v};
  set('yr2DayNum',elapsed);set('yr2PctBadge',pct+'%');set('yr2DateRange','Day '+elapsed+' of 730');
  set('yr2StartLabel',fmt(start));set('yr2EndLabel',fmt(end));
  set('yr2Week',Math.min(Math.ceil(elapsed/7),104));set('yr2Month',Math.min(Math.ceil(elapsed/30.44),24));
  set('yr2Quarter',Math.min(Math.ceil(elapsed/91.25),8));set('yr2Year',elapsed<=365?1:2);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{const b=document.getElementById('yr2Bar');if(b)b.style.width=pct+'%'}));
}

function quickToggle(id){const k=dateStr(TODAY);if(!DB.dailyLogs[k])DB.dailyLogs[k]={};DB.dailyLogs[k][id]=!DB.dailyLogs[k][id];updateHabitStreak(id);saveData();renderDashboard();renderDaily()}

/* ‚îÄ‚îÄ DAILY ‚îÄ‚îÄ */
function renderDaily(){
  const k=dateStr(TODAY),log=DB.dailyLogs[k]||{};
  document.getElementById('habitList').innerHTML=!DB.habits.length
    ?'<div class="empty-state"><div class="ei">üå±</div><p>Add your first habit to start tracking</p></div>'
    :DB.habits.map(h=>{const d=!!log[h.id];return`<div class="habit-item ${d?'done':''}" onclick="toggleHabit('${h.id}')"><div class="hc">${d?'‚úì':''}</div><span style="font-size:20px">${h.icon}</span><div class="hname">${h.name}</div><div class="hstreak">üî•${h.streak||0}</div><div onclick="event.stopPropagation()"><div class="icon-btn" onclick="deleteHabit('${h.id}')">‚úï</div></div></div>`}).join('');
  const d=DB.habits.filter(h=>log[h.id]).length,t=DB.habits.length,p=t?Math.round(d/t*100):0;
  document.getElementById('dailyPct').textContent=p+'%';
  document.getElementById('dailyBar').style.width=p+'%';
  renderTimeBlocks(k);
  document.getElementById('dailyNotes').value=(DB.dailyLogs[k]||{}).notes||'';
  renderDailyWins(k);
}

function toggleHabit(id){const k=dateStr(TODAY);if(!DB.dailyLogs[k])DB.dailyLogs[k]={};DB.dailyLogs[k][id]=!DB.dailyLogs[k][id];updateHabitStreak(id);saveData();renderDaily();updateStreak();showToast(DB.dailyLogs[k][id]?'‚úÖ Done!':'Unmarked')}
function updateHabitStreak(id){const h=DB.habits.find(x=>x.id===id);if(!h)return;let s=0,d=new Date(TODAY);while(true){const k=dateStr(d);if(DB.dailyLogs[k]&&DB.dailyLogs[k][id]){s++;d.setDate(d.getDate()-1)}else break}h.streak=s}

function renderTimeBlocks(dk){
  const blocks=DB.timeBlocks[dk]||{},slots=generateTimeSlots();
  document.getElementById('timeBlocks').innerHTML=slots.map(s=>{const t=blocks[s]||null;return buildSlotHtml(dk,s,t,false)}).join('');
  renderDailyWins(dk);
}

function buildSlotHtml(dk,s,t,fromDay){
  const fn=fromDay?'ForDay':'';

  // Empty slot
  if(!t) return`<div class="ts-empty" onclick="openTimeModal${fn}('${dk}','${s}')">
    <div class="tl">${s}</div>
    <div class="tt">+ tap to add task</div>
  </div>`;

  // Booked slot
  const status = t.status||'todo';
  const catLabel = t.cat ? catEmoji(t.cat)+' '+t.cat.replace(/-/g,' ') : '';

  // 3 status tab buttons ‚Äî always visible
  const tabs = ['todo','inprogress','done'];
  const tabLabels = {todo:'‚óã Todo', inprogress:'‚ñ∂ In Progress', done:'‚úì Done'};
  const tabsHtml = tabs.map(v =>
    `<button class="ts-stab${status===v?' active-'+v:''}"
       onclick="event.stopPropagation();setSlotStatus('${dk}','${s}','${v}')"
     >${tabLabels[v]}</button>`
  ).join('');

  return`<div class="ts-card s-${status}" id="tscard_${dk}_${s.replace(':','_')}">
    <div class="ts-top">
      <div class="tl">${s}</div>
      <div class="tt">${t.task}</div>
      <div class="ts-editbtn" onclick="openTimeModal${fn}('${dk}','${s}')" title="Edit">‚úé</div>
    </div>
    <div class="ts-bottom">
      <div class="ts-cat">${catLabel}</div>
      <div class="ts-status-tabs">${tabsHtml}</div>
    </div>
  </div>`;
}

function catEmoji(cat){return{'deep-work':'üß†',deep:'üß†',meeting:'ü§ù',exercise:'üí™',learning:'üìö',personal:'üè†'}[cat]||'üìå'}

function setSlotStatus(dk, slot, newStatus){
  if(!DB.timeBlocks[dk]||!DB.timeBlocks[dk][slot]) return;
  const t = DB.timeBlocks[dk][slot];
  t.status = newStatus;
  t.done = newStatus==='done';
  saveData();
  // Re-render just this card in-place
  const cardId = 'tscard_'+dk+'_'+slot.replace(':','_');
  const card = document.getElementById(cardId);
  if(card){
    const fromDay = !!card.closest('#dayModalContent');
    card.outerHTML = buildSlotHtml(dk, slot, t, fromDay);
  } else {
    // fallback: full re-render
    renderTimeBlocks(dk);
  }
  renderDailyWins(dk);
  if(document.getElementById('pendingTasks')) renderPendingTasks();
  const msgs={todo:'Marked Todo',inprogress:'‚ñ∂ In Progress',done:'‚úÖ Done! üèÜ'};
  showToast(msgs[newStatus]||'Updated');
}

// backward compat for pending panel
function cycleSlotStatus(dk,slot){
  if(!DB.timeBlocks[dk]||!DB.timeBlocks[dk][slot]) return;
  const t=DB.timeBlocks[dk][slot];
  const cycle={todo:'inprogress',inprogress:'done',done:'todo',none:'inprogress'};
  setSlotStatus(dk,slot,cycle[t.status||'todo']);
}
function toggleSlotDone(dk,slot){cycleSlotStatus(dk,slot)}

function renderDailyWins(dk){
  const winsCard=document.getElementById('dailyWinsCard');
  const winsList=document.getElementById('winsList');
  if(!winsCard||!winsList) return;
  const blocks=DB.timeBlocks[dk]||{};
  const tasks=Object.entries(blocks).filter(([,t])=>t&&t.task).map(([slot,t])=>({slot,task:t.task,cat:t.cat,status:t.status||'todo'}));
  const total=tasks.length,done=tasks.filter(t=>t.status==='done').length,ip=tasks.filter(t=>t.status==='inprogress').length;
  const wt=document.getElementById('winsTotal'),wi=document.getElementById('winsIP'),wd=document.getElementById('winsDone');
  if(wt)wt.textContent=total;if(wi)wi.textContent=ip;if(wd)wd.textContent=done;
  if(!tasks.length){winsList.innerHTML='<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px">Add tasks to your time blocks above</div>';return;}
  // Sort: done last, inprogress first, then by slot
  const order={inprogress:0,todo:1,none:1,done:2};
  tasks.sort((a,b)=>order[a.status]-order[b.status]||a.slot.localeCompare(b.slot));
  winsList.innerHTML=tasks.map(t=>{
    const cls=t.status==='done'?'wins-task-row wins-task-done':t.status==='inprogress'?'wins-task-row wins-task-ip':'wins-task-row';
    const icon=t.status==='done'?'‚úì ':t.status==='inprogress'?'‚ñ∂ ':'‚óã ';
    const iconColor=t.status==='done'?'var(--emerald)':t.status==='inprogress'?'var(--blue)':'var(--text3)';
    const textStyle=t.status==='done'?'text-decoration:line-through;color:var(--text3)':'';
    return`<div class="${cls}">
      <span style="font-size:14px;color:${iconColor};flex-shrink:0;cursor:pointer" onclick="cycleSlotStatus('${dk}','${t.slot}')" title="Click to cycle status">${icon}</span>
      <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);flex-shrink:0;width:36px">${t.slot}</span>
      <span style="font-size:13px;flex:1;${textStyle}">${t.task}${t.cat?` ${catEmoji(t.cat)}`:''}</span>
      <span style="font-family:'DM Mono',monospace;font-size:9px;padding:2px 7px;border-radius:10px;color:${iconColor};background:${t.status==='done'?'rgba(52,211,153,.1)':t.status==='inprogress'?'rgba(56,189,248,.1)':'rgba(255,255,255,.04)'};border:1px solid ${t.status==='done'?'rgba(52,211,153,.2)':t.status==='inprogress'?'rgba(56,189,248,.2)':'rgba(255,255,255,.06)'}">${t.status==='done'?'Done':t.status==='inprogress'?'In Progress':'Pending'}</span>
    </div>`;
  }).join('');
}

function generateTimeSlots(){const slots=[],p=DB.prefs,[sh]=((p.workStart||'09:00').split(':')).map(Number),[eh]=((p.workEnd||'18:00').split(':')).map(Number);let h=sh,m=0;while(h<eh){slots.push(pad(h)+':'+pad(m));m+=30;if(m>=60){m=0;h++}}return slots}

function openTimeModal(dk,slot){editingTimeSlot={dateKey:dk,slot};const ex=(DB.timeBlocks[dk]||{})[slot];document.getElementById('timeModalTitle').textContent='Book '+slot;document.getElementById('timeTask').value=ex?ex.task:'';document.getElementById('timeCategory').value=ex?ex.cat:'deep-work';openModal('timeModal')}
function saveTimeBlock(){const{dateKey,slot}=editingTimeSlot;if(!DB.timeBlocks[dateKey])DB.timeBlocks[dateKey]={};const t=document.getElementById('timeTask').value.trim();if(t)DB.timeBlocks[dateKey][slot]={task:t,cat:document.getElementById('timeCategory').value};else delete DB.timeBlocks[dateKey][slot];saveData();if(editingTimeSlot._fromDay){closeModal('timeModal');setTimeout(()=>renderDayModal(dateKey),50)}else{renderTimeBlocks(dateKey);closeModal('timeModal')}showToast('Time block saved!')}
function saveDailyNotes(){const k=dateStr(TODAY);if(!DB.dailyLogs[k])DB.dailyLogs[k]={};DB.dailyLogs[k].notes=document.getElementById('dailyNotes').value;saveData()}

/* ‚îÄ‚îÄ WEEKLY ‚îÄ‚îÄ */
function renderWeekly(){
  const ws=getWeekStart(TODAY,currentWeekOffset),we=new Date(ws);we.setDate(we.getDate()+6);
  document.getElementById('weekLabel').textContent=fmtShort(ws)+' ‚Äî '+fmtShort(we);
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  document.getElementById('weekDays').innerHTML=Array.from({length:7},(_,i)=>{
    const d=new Date(ws);d.setDate(d.getDate()+i);const k=dateStr(d),log=DB.dailyLogs[k]||{};
    const dn=DB.habits.filter(h=>log[h.id]).length,t=DB.habits.length,p=t?Math.round(dn/t*100):0;
    const isT=k===dateStr(TODAY),sc=p>=80?'var(--emerald)':p>=50?'var(--gold)':'var(--rose)';
    return`<div class="week-day ${isT?'today':''}" onclick="showDayDetail('${k}')"><div class="wday-label">${days[d.getDay()]}</div><div class="wday-num">${d.getDate()}</div>${d<=TODAY?`<div class="wday-score" style="color:${sc}">${p}%</div>`:''}<div class="wday-dots">${DB.habits.slice(0,6).map(h=>`<div class="wd ${log[h.id]?'done':''}"></div>`).join('')}</div></div>`;
  }).join('');
  let td=0,tp=0;for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);if(d<=TODAY){const l=DB.dailyLogs[dateStr(d)]||{};td+=DB.habits.filter(h=>l[h.id]).length;tp+=DB.habits.length}}
  const wp=tp?Math.round(td/tp*100):0;
  document.getElementById('weekSummary').innerHTML=`<div class="pw"><div class="ph"><span class="pl">Week Completion</span><span class="pp">${wp}%</span></div><div class="pb"><div class="pf" style="width:${wp}%"></div></div></div><div style="display:flex;gap:20px;margin-top:14px"><div><div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">Completed</div><div style="font-family:'Playfair Display',serif;font-weight:700;font-size:24px;color:var(--emerald)">${td}</div></div><div><div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px">Possible</div><div style="font-family:'Playfair Display',serif;font-weight:700;font-size:24px;color:var(--text2)">${tp}</div></div></div>`;
  renderPendingTasks();
  renderYearMaps();
}

function renderPendingTasks(){
  // Collect all pending (booked but not done) time blocks across all dates
  const pending=[];
  Object.entries(DB.timeBlocks).forEach(([dk,slots])=>{
    Object.entries(slots).forEach(([slot,t])=>{
      if(t&&t.task&&(t.status||'todo')!=='done'){
        pending.push({dk,slot,task:t.task,cat:t.cat,status:t.status||'todo'});
      }
    });
  });
  // Sort by date then slot
  pending.sort((a,b)=>a.dk.localeCompare(b.dk)||a.slot.localeCompare(b.slot));
  const el=document.getElementById('pendingTasks');
  if(!el) return;
  if(!pending.length){el.innerHTML='<div class="empty-state" style="padding:20px"><div class="ei">üéâ</div><p>All tasks done!</p></div>';return;}
  el.innerHTML=pending.map(p=>{
    const d=new Date(p.dk+'T00:00:00');
    const dateLabel=d.toLocaleDateString('en-IN',{weekday:'short',day:'numeric',month:'short'});
    const isOverdue=p.dk<dateStr(TODAY);
    const labelColor=isOverdue?'var(--rose)':p.dk===dateStr(TODAY)?'var(--gold)':'var(--text3)';
    const sIcon=p.status==='inprogress'?'‚ñ∂':'‚óã';
    const sColor=p.status==='inprogress'?'var(--blue)':'var(--text3)';
    const slotCls=p.status==='inprogress'?'inprogress-slot':'booked';
    return`<div class="ts ${slotCls}" style="margin-bottom:4px">
      <div class="tl" style="width:50px;color:${labelColor};font-size:9px">${dateLabel}</div>
      <div class="tt" style="${isOverdue?'color:var(--rose)':''}">
        ${p.task}${p.cat?` <span style="font-size:10px">${catEmoji(p.cat)}</span>`:''}
      </div>
      <span style="font-size:9px;font-family:'DM Mono',monospace;color:${isOverdue?'var(--rose)':'var(--text3)'}">
        ${p.slot}${isOverdue?' ‚ö†':''}
      </span>
      <button class="ts-statbtn s-${p.status==='inprogress'?'inprogress':'none'}" onclick="event.stopPropagation();toggleSlotDone('${p.dk}','${p.slot}')" title="Cycle status">
        ${p.status==='inprogress'?'‚ñ∂ In Progress':'‚óã Todo'}
      </button>
    </div>`;
  }).join('');
}

function changeWeek(dir){currentWeekOffset+=dir;renderWeekly()}

function renderYearMaps(){
  const container=document.getElementById('yearMaps'),yr=TODAY.getFullYear();let html='';
  for(let y=yr-1;y<=yr+1;y++){
    html+=`<div class="year-label">${y}</div><div class="year-grid">`;
    const start=new Date(y,0,1),end=new Date(y,11,31);
    for(let i=0;i<start.getDay();i++)html+=`<div class="yc" style="background:transparent;cursor:default"></div>`;
    for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
      const k=dateStr(d),isT=k===dateStr(TODAY),log=DB.dailyLogs[k]||{},dn=DB.habits.filter(h=>log[h.id]).length,t=DB.habits.length;
      let lvl='';if(t>0&&dn>0){const p=dn/t;lvl=p>=.9?'l4':p>=.7?'l3':p>=.4?'l2':'l1'}
      html+=`<div class="yc ${lvl} ${isT?'today':''}" title="${k}: ${dn}/${t}" onclick="showDayDetail('${k}')"></div>`;
    }
    html+='</div>';
  }
  container.innerHTML=html;
}

/* ‚îÄ‚îÄ MONTHLY ‚îÄ‚îÄ */
function renderMonthly(){
  const yr=currentMonthDate.getFullYear(),mo=currentMonthDate.getMonth();
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('monthTitle').textContent=months[mo]+' '+yr;
  const first=new Date(yr,mo,1),last=new Date(yr,mo+1,0);let html='';
  for(let i=0;i<first.getDay();i++)html+='<div class="dc empty"></div>';
  for(let d=1;d<=last.getDate();d++){const date=new Date(yr,mo,d),k=dateStr(date),isT=k===dateStr(TODAY),log=DB.dailyLogs[k]||{},dn=DB.habits.filter(h=>log[h.id]).length,t=DB.habits.length;html+=`<div class="dc ${isT?'today':''} ${dn>0?'has-data':''} ${t>0&&dn/t>=.7?'done':''}" onclick="showDayDetail('${k}')">${d}</div>`}
  document.getElementById('monthGrid').innerHTML=html;
  let tot=0,comp=0,sum=0;
  for(let d=1;d<=last.getDate();d++){const date=new Date(yr,mo,d);if(date>TODAY)continue;const k=dateStr(date),log=DB.dailyLogs[k]||{},dn=DB.habits.filter(h=>log[h.id]).length,t=DB.habits.length;tot++;if(t>0&&dn/t>=.7)comp++;sum+=t>0?dn/t*100:0}
  const avg=tot?Math.round(sum/tot):0;
  document.getElementById('monthlyStats').innerHTML=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">${[['Good Days',comp,'var(--emerald)'],['Avg Rate',avg+'%','var(--teal)'],['Tracked',tot+'d','var(--gold)']].map(([l,v,c])=>`<div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;text-align:center"><div style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">${l}</div><div style="font-family:'Playfair Display',serif;font-weight:700;font-size:22px;color:${c}">${v}</div></div>`).join('')}</div>`;
  document.getElementById('habitConsistency').innerHTML=DB.habits.map(h=>{let c=0,t2=0;for(let d=1;d<=last.getDate();d++){const date=new Date(yr,mo,d);if(date>TODAY)continue;t2++;if((DB.dailyLogs[dateStr(date)]||{})[h.id])c++}const p=t2?Math.round(c/t2*100):0;return`<div class="pw"><div class="ph"><span class="pl">${h.icon} ${h.name}</span><span class="pp">${p}%</span></div><div class="pb"><div class="pf" style="width:${p}%"></div></div></div>`}).join('');
}
function changeMonth(dir){currentMonthDate.setMonth(currentMonthDate.getMonth()+dir);renderMonthly()}

/* ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ */
function renderGoals(){
  const goals=activeGoalFilter==='all'?DB.goals:DB.goals.filter(g=>g.category===activeGoalFilter);
  if(!goals.length){document.getElementById('goalsList').innerHTML='<div class="empty-state"><div class="ei">üéØ</div><p>No goals yet. Set your first 2-year goal!</p></div>';return}
  document.getElementById('goalsList').innerHTML=goals.map(g=>{const p=Math.min(100,Math.round((g.progress||0)/g.target*100)),dl=g.deadline?Math.max(0,Math.ceil((new Date(g.deadline)-TODAY)/86400000)):'‚àû';return`<div class="goal-item"><div class="goal-header"><div><div class="goal-title">${g.icon||'üéØ'} ${g.title}</div><div class="goal-meta">${g.deadline?'üìÖ '+g.deadline+' ¬∑ ':''}‚è≥ ${dl} days left</div></div><div class="goal-badge badge-${g.category}">${g.category}</div></div>${g.description?`<div style="font-size:12px;color:var(--text3);margin-bottom:12px;line-height:1.6">${g.description}</div>`:''}<div class="pw"><div class="ph"><span class="pl">${g.progress||0} / ${g.target} ${g.unit}</span><span class="pp">${p}%</span></div><div class="pb"><div class="pf" style="width:${p}%"></div></div></div><div class="goal-actions"><input type="number" class="gin" id="gupd_${g.id}" value="${g.progress||0}" min="0" max="${g.target}"><button class="btn btn-primary" onclick="updateGoalProgress('${g.id}')">Update</button>${g.completed?'':`<button class="btn btn-ghost" onclick="completeGoal('${g.id}')">‚úì Done</button>`}<button class="btn btn-danger" onclick="deleteGoal('${g.id}')">‚úï</button></div></div>`}).join('');
}
function filterGoals(f,el){activeGoalFilter=f;document.querySelectorAll('#goalFilter .tag').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderGoals()}
function openAddGoal(){document.getElementById('goalTitle').value='';document.getElementById('goalTarget').value='';document.getElementById('goalUnit').value='';document.getElementById('goalDesc').value='';const d=new Date(TODAY);d.setFullYear(d.getFullYear()+2);document.getElementById('goalDeadline').value=dateStr(d);openModal('goalModal')}
function saveGoal(){const title=document.getElementById('goalTitle').value.trim();if(!title){showToast('Enter goal title');return}const icons={work:'üíº',personal:'üåü',health:'üí™',finance:'üí∞'},cat=document.getElementById('goalCategory').value;DB.goals.push({id:uid(),title,category:cat,icon:icons[cat],target:parseFloat(document.getElementById('goalTarget').value)||100,unit:document.getElementById('goalUnit').value||'%',deadline:document.getElementById('goalDeadline').value,description:document.getElementById('goalDesc').value,progress:0,completed:false,createdAt:dateStr(TODAY)});saveData();renderGoals();closeModal('goalModal');showToast('Goal set! üéØ')}
function updateGoalProgress(id){const g=DB.goals.find(x=>x.id===id);if(!g)return;const v=parseFloat(document.getElementById('gupd_'+id).value)||0;g.progress=Math.min(v,g.target);if(g.progress>=g.target)g.completed=true;saveData();renderGoals();showToast(`Progress: ${Math.round(g.progress/g.target*100)}%`)}
function completeGoal(id){const g=DB.goals.find(x=>x.id===id);if(g){g.completed=true;g.progress=g.target}saveData();renderGoals();showToast('Goal completed! üéâ')}
function deleteGoal(id){if(!confirm('Delete this goal?'))return;DB.goals=DB.goals.filter(g=>g.id!==id);saveData();renderGoals()}

/* ‚îÄ‚îÄ HABITS ‚îÄ‚îÄ */
function openAddHabit(){editingHabitId=null;document.getElementById('habitName').value='';document.getElementById('habitIcon').value='';document.getElementById('habitModalTitle').textContent='Add Habit';openModal('habitModal')}
function saveHabit(){const name=document.getElementById('habitName').value.trim();if(!name){showToast('Enter habit name');return}if(editingHabitId){const h=DB.habits.find(x=>x.id===editingHabitId);if(h){h.name=name;h.icon=document.getElementById('habitIcon').value||'‚úÖ';h.category=document.getElementById('habitCategory').value}}else DB.habits.push({id:uid(),name,icon:document.getElementById('habitIcon').value||'‚úÖ',category:document.getElementById('habitCategory').value,createdAt:dateStr(TODAY),streak:0});saveData();renderDaily();renderDashboard();closeModal('habitModal');showToast(editingHabitId?'Updated!':'Habit added!');editingHabitId=null}
function deleteHabit(id){if(!confirm('Delete this habit?'))return;DB.habits=DB.habits.filter(h=>h.id!==id);saveData();renderDaily();renderDashboard();showToast('Deleted')}

/* ‚îÄ‚îÄ DAY DETAIL ‚îÄ‚îÄ */
let activeDayKey = null;

function showDayDetail(dk){
  activeDayKey = dk;
  renderDayModal(dk);
  openModal('dayModal');
}

function renderDayModal(dk){
  if(!DB.dailyLogs[dk]) DB.dailyLogs[dk]={};
  const log=DB.dailyLogs[dk]||{};
  const d2=DB.habits.filter(h=>log[h.id]).length,t=DB.habits.length,p=t?Math.round(d2/t*100):0;
  const dateObj=new Date(dk+'T00:00:00');
  document.getElementById('dayModalTitle').textContent=dateObj.toLocaleDateString('en-IN',{weekday:'long',month:'long',day:'numeric'});

  // Time blocks for this day
  const blocks=DB.timeBlocks[dk]||{};
  const slots=generateTimeSlots();
  const tbHtml=slots.length?`
    <div class="card-title" style="margin-top:16px;margin-bottom:10px"><div class="card-icon">üïê</div> Time Blocks</div>
    <div class="tbgrid" id="dayModalTbGrid">${slots.map(s=>{const tb=blocks[s]||null;return buildSlotHtml(dk,s,tb,true)}).join('')}</div>`:'';

  document.getElementById('dayModalContent').innerHTML=`
    <div class="pw" style="margin-bottom:14px">
      <div class="ph"><span class="pl">Completion</span><span class="pp" id="dayModalPct">${p}%</span></div>
      <div class="pb"><div class="pf" id="dayModalBar" style="width:${p}%"></div></div>
    </div>
    <div class="card-title" style="margin-bottom:10px"><div class="card-icon">‚úÖ</div> Habits <span style="color:var(--text3);font-size:10px;margin-left:4px">‚Äî tap to toggle</span></div>
    <div class="habit-list" id="dayModalHabits" style="margin-bottom:14px">
      ${DB.habits.map(h=>`<div class="habit-item ${log[h.id]?'done':''}" id="dh_${h.id}" onclick="toggleHabitOnDay('${dk}','${h.id}')">
        <div class="hc">${log[h.id]?'‚úì':''}</div>
        <span style="font-size:18px">${h.icon}</span>
        <div class="hname">${h.name}</div>
        ${log[h.id]?'<span style="font-size:11px;color:var(--emerald)">‚úì done</span>':''}
      </div>`).join('')}
    </div>
    ${tbHtml}
    <div class="card-title" style="margin-top:16px;margin-bottom:10px"><div class="card-icon">üìù</div> Notes</div>
    <textarea class="input" id="dayModalNotes" rows="3" placeholder="Wins, blockers, reflections..." style="resize:none;line-height:1.7" onblur="saveDayModalNotes('${dk}')">${log.notes||''}</textarea>
  `;
}

function toggleHabitOnDay(dk, habitId){
  if(!DB.dailyLogs[dk]) DB.dailyLogs[dk]={};
  DB.dailyLogs[dk][habitId]=!DB.dailyLogs[dk][habitId];
  // Recalc streak only for today
  if(dk===dateStr(TODAY)) updateHabitStreak(habitId);
  saveData();
  // Update modal UI without re-opening
  const log=DB.dailyLogs[dk]||{};
  const el=document.getElementById('dh_'+habitId);
  if(el){
    const done=!!log[habitId];
    el.className='habit-item'+(done?' done':'');
    el.querySelector('.hc').textContent=done?'‚úì':'';
    const badge=el.querySelector('span:last-child');
    if(done&&badge&&badge.textContent!=='‚úì done'){badge.textContent='‚úì done';badge.style.color='var(--emerald)';badge.style.fontSize='11px';}
    else if(!done&&badge){badge.textContent='';}
  }
  // Update progress bar in modal
  const d2=DB.habits.filter(h=>log[h.id]).length,t=DB.habits.length,p=t?Math.round(d2/t*100):0;
  const pctEl=document.getElementById('dayModalPct');const barEl=document.getElementById('dayModalBar');
  if(pctEl)pctEl.textContent=p+'%';if(barEl)barEl.style.width=p+'%';
  // Refresh dashboard/daily if relevant
  if(dk===dateStr(TODAY)){renderDashboard();renderDaily();}
  else{renderDashboard();}
  showToast(log[habitId]?'‚úÖ Marked done!':'Unmarked');
}

function openTimeModalForDay(dk, slot){
  editingTimeSlot={dateKey:dk, slot};
  const ex=(DB.timeBlocks[dk]||{})[slot];
  document.getElementById('timeModalTitle').textContent='Book '+slot;
  document.getElementById('timeTask').value=ex?ex.task:'';
  document.getElementById('timeCategory').value=ex?ex.cat:'deep-work';
  // Override save to re-render day modal after save
  openModal('timeModal');
  // Store context so saveTimeBlock re-renders correctly
  editingTimeSlot._fromDay=true;
}

function saveDayModalNotes(dk){
  if(!DB.dailyLogs[dk])DB.dailyLogs[dk]={};
  const notes=document.getElementById('dayModalNotes');
  if(notes){DB.dailyLogs[dk].notes=notes.value;saveData();}
}

/* ‚îÄ‚îÄ STREAK ‚îÄ‚îÄ */
function calcStreak(){let s=0,d=new Date(TODAY);while(true){const k=dateStr(d),l=DB.dailyLogs[k]||{},dn=DB.habits.filter(h=>l[h.id]).length,t=DB.habits.length;if(t>0&&dn/t>=.5){s++;d.setDate(d.getDate()-1)}else break}return s}
function updateStreak(){document.getElementById('streakChip').textContent='üî• '+calcStreak()+'d'}
function calcGoalAvgProgress(){if(!DB.goals.length)return 0;return Math.round(DB.goals.reduce((a,g)=>a+Math.min(100,Math.round((g.progress||0)/g.target*100)),0)/DB.goals.length)}
function calcHabitConsistency30(){if(!DB.habits.length)return 0;let tot=0,dn=0;for(let i=0;i<30;i++){const d=new Date(TODAY);d.setDate(d.getDate()-i);const l=DB.dailyLogs[dateStr(d)]||{};DB.habits.forEach(h=>{tot++;if(l[h.id])dn++})}return tot?Math.round(dn/tot*100):0}

/* ‚îÄ‚îÄ GOOGLE DRIVE ‚îÄ‚îÄ */
let gapiLoaded=false,gisLoaded=false,tokenClient;
const SCOPES='https://www.googleapis.com/auth/drive.file',FILE_NAME='apex-productivity-data.json';
function saveClientId(){localStorage.setItem('apex_client_id',document.getElementById('clientIdInput').value.trim())}
function initGoogleAPI(){
  const cid=localStorage.getItem('apex_client_id');if(!cid)return;
  const g1=document.createElement('script');g1.src='https://apis.google.com/js/api.js';
  g1.onload=()=>gapi.load('client',async()=>{await gapi.client.init({discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']});gapiLoaded=true;checkAuthReady()});
  document.head.appendChild(g1);
  const g2=document.createElement('script');g2.src='https://accounts.google.com/gsi/client';
  g2.onload=()=>{tokenClient=google.accounts.oauth2.initTokenClient({client_id:cid,scope:SCOPES,callback:async resp=>{if(resp.error){showToast('Auth failed');return}DB.googleToken=resp.access_token;saveData();await syncToDrive()}});gisLoaded=true;checkAuthReady()};
  document.head.appendChild(g2);
}
function checkAuthReady(){if(gapiLoaded&&gisLoaded)updateAuthUI()}
function updateAuthUI(){const el=document.getElementById('authArea');if(!el)return;el.innerHTML=DB.googleToken?`<div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-primary" onclick="syncToDrive()">‚òÅÔ∏è Sync Now</button><button class="btn btn-ghost" onclick="loadFromDrive()">‚¨áÔ∏è Load from Drive</button><button class="btn btn-ghost" onclick="signOut()">Sign Out</button></div><p class="text-muted mt8">‚úÖ Connected to Google Drive</p>`:`<button class="btn btn-primary" onclick="signIn()">üîê Connect Google Drive</button>`}
function signIn(){if(!gapiLoaded||!gisLoaded||!tokenClient){initGoogleAPI();showToast('Loading Google API...');setTimeout(signIn,2000);return}gapi.client.getToken()===null?tokenClient.requestAccessToken({prompt:'consent'}):tokenClient.requestAccessToken({prompt:''})}
function signOut(){const t=gapi.client.getToken();if(t)google.accounts.oauth2.revoke(t.access_token);gapi.client.setToken('');DB.googleToken=null;DB.driveFileId=null;saveData();updateAuthUI();showToast('Signed out');updateSyncBtn('idle')}
async function handleSync(){const cid=localStorage.getItem('apex_client_id');if(!cid){switchView('settings',document.querySelectorAll('.nav-item')[5]);showToast('Set up Google Drive first');return}if(DB.googleToken)await syncToDrive();else signIn()}
async function syncToDrive(){if(!DB.googleToken){signIn();return}updateSyncBtn('syncing');gapi.client.setToken({access_token:DB.googleToken});try{const content=JSON.stringify(DB,null,2);if(DB.driveFileId){await gapi.client.request({path:`/upload/drive/v3/files/${DB.driveFileId}`,method:'PATCH',params:{uploadType:'media'},headers:{'Content-Type':'application/json'},body:content})}else{const s=await gapi.client.drive.files.list({q:`name='${FILE_NAME}' and trashed=false`,fields:'files(id,name)'});const f=s.result.files;if(f&&f.length>0){DB.driveFileId=f[0].id;await gapi.client.request({path:`/upload/drive/v3/files/${DB.driveFileId}`,method:'PATCH',params:{uploadType:'media'},headers:{'Content-Type':'application/json'},body:content})}else{const m=await gapi.client.drive.files.create({resource:{name:FILE_NAME,mimeType:'application/json'},fields:'id'});DB.driveFileId=m.result.id;await gapi.client.request({path:`/upload/drive/v3/files/${DB.driveFileId}`,method:'PATCH',params:{uploadType:'media'},headers:{'Content-Type':'application/json'},body:content})}}saveData();updateSyncBtn('synced');showToast('‚úÖ Synced to Google Drive!')}catch(e){updateSyncBtn('idle');if(e.status===401){DB.googleToken=null;saveData();signIn()}else showToast('Sync failed: '+(e.result?.error?.message||e.message))}}
async function loadFromDrive(){if(!DB.googleToken){signIn();return}gapi.client.setToken({access_token:DB.googleToken});updateSyncBtn('syncing');try{let fid=DB.driveFileId;if(!fid){const s=await gapi.client.drive.files.list({q:`name='${FILE_NAME}' and trashed=false`,fields:'files(id)'});const f=s.result.files;if(!f||!f.length){showToast('No backup found');updateSyncBtn('idle');return}fid=f[0].id;DB.driveFileId=fid}const r=await gapi.client.drive.files.get({fileId:fid,alt:'media'});const data=typeof r.result==='string'?JSON.parse(r.result):r.result;DB={...DB,...data,googleToken:DB.googleToken,driveFileId:fid};saveData();renderAll();updateSyncBtn('synced');showToast('‚úÖ Loaded from Drive!')}catch(e){updateSyncBtn('idle');showToast('Load failed: '+(e.result?.error?.message||e.message))}}
function updateSyncBtn(state){const btn=document.getElementById('syncBtn'),label=document.getElementById('syncLabel');btn.className='sync-btn';if(state==='syncing'){btn.classList.add('syncing');label.textContent='Syncing...'}else if(state==='synced'){btn.classList.add('synced');label.textContent='Synced ‚úì';setTimeout(()=>updateSyncBtn('idle'),3000)}else label.textContent='Sync'}

/* ‚îÄ‚îÄ DATA OPS ‚îÄ‚îÄ */
function exportData(){const b=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`apex-backup-${dateStr(TODAY)}.json`;a.click();URL.revokeObjectURL(u);showToast('Exported!')}
function importTrigger(){document.getElementById('importFile').click()}
function importData(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);DB={...DB,...d};saveData();renderAll();showToast('Imported!')}catch{showToast('Invalid file')}};r.readAsText(f)}
function clearAllData(){if(!confirm('Delete ALL data?'))return;DB={habits:[],dailyLogs:{},goals:[],timeBlocks:{},prefs:DB.prefs,googleToken:null,driveFileId:null};saveData();renderAll();showToast('Cleared')}

/* ‚îÄ‚îÄ PREFS ‚îÄ‚îÄ */
function savePrefs(){DB.prefs={...DB.prefs,name:document.getElementById('userName').value,workStart:document.getElementById('workStart').value,workEnd:document.getElementById('workEnd').value,dailyTarget:parseInt(document.getElementById('dailyTarget').value),journeyStart:document.getElementById('journeyStart').value||DB.prefs.journeyStart||dateStr(TODAY)};saveData();setGreeting();renderTwoYearCounter()}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden'}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow=''}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)closeModal(o.id)}));

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
let tt;function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(tt);tt=setTimeout(()=>t.classList.remove('show'),2500)}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
function uid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function pad(n){return String(n).padStart(2,'0')}
function dateStr(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())}
function fmtShort(d){return d.toLocaleDateString('en-IN',{day:'numeric',month:'short'})}
function getWeekStart(base,offset){const d=new Date(base);d.setDate(d.getDate()-d.getDay()+(offset*7));d.setHours(0,0,0,0);return d}

/* ‚îÄ‚îÄ PWA ‚îÄ‚îÄ */
const mf={name:'APEX ‚Äî Productivity Tracker',short_name:'APEX',start_url:window.location.href,display:'standalone',background_color:'#070a12',theme_color:'#00c9a7',orientation:'portrait',icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="%23070a12"/><text x="256" y="360" font-size="300" text-anchor="middle">‚ö°</text></svg>',sizes:'512x512',type:'image/svg+xml'}]};
const mb=new Blob([JSON.stringify(mf)],{type:'application/json'});
document.getElementById('manifest-placeholder').href=URL.createObjectURL(mb);

init();
</script>
</body>
</html>
